/**
 * Defines a number of tasks used in setting up Nova
 *
 * This file will handle downloading MCP, patching the MCP code, generating the
 * patch file, and ensuring that the user has all the dependencies that they need.
 */

task help {
    doLast {
    logger.info('''\
Allows you to set up Nova on a new machine. This script also checks that you have all the things that Nova needs, that they're on your PATH, and all the other fun stuff.

Available tasks:

 * setup                - Downloads MCP, unzips it, moves it to the right place, and applies the source code transformations to Minecraft so that Nova will be run properly. Before any of that, though, this tasks checks that you have all the right programs installed to your PATH

 * makePatch            - makes the source code patch that Nova uses to distribute its changes to the MC source code

 * verifyEnvironment    - Checks that you have all the right tools on your PATH
''')
    }
}

task verifyEnvironment << {
    checkCMake()
    checkJava()

    def gccAvailable = hasGCC()
    def msvcAvailable = hasMSVC()

    if(!msvcAvailable) {
        logger.warn("Could not find MSVC. If you want to use MSVC to compile Nova, please use the Visual Studio Developer Command Prompt (just Google it)")
    } else {
        logger.info('Visual Studio found!')
    }

    if(!gccAvailable) {
        logger.warn('Could not find GCC. If you want to use GCC to compile Nova, please install it to your PATH and try again')
    } else {
        logger.info('GCC found!')
    }

    if(!gccAvailable && !msvcAvailable) {
        logger.fatal('Neither Visual Stusio not GCC are available. Please install one of these and add its location to your PATH')
        throw new GradleScriptException()
    }

    logger.info('All build tools detected')
}

task makeMcpDir(dependsOn: verifyEnvironment) << {
    def mcpDir = new File(project.buildDir, '../mcp')
    if(!mcpDir.exists()) {
        mcpDir.mkdirs()
    }
}

task downloadMcp(type: Download, dependsOn: makeMcpDir) << {
    src 'http://www.modcoderpack.com/website/sites/default/files/releases/mcp931.zip'
    dest 'mcp.zip'
}

task unzipMcp(type: Copy, dependsOn: downloadMcp) << {
    logger.info('Unzipping MCP...')
    def zipFile = file('dump_not_exist_mcp931.zip')
    def outputDir = file("mcp/")

    logger.info('zipFile: ' + zipFile + ' outputDir: ' + outputDir)
 
    from zipTree(zipFile)
    into outputDir
}

task decompileMcp(dependsOn: unzipMcp) << {
    def decompileResult = (project.buildDir + '../mcp/decompile.bat').execute()
    if(decompileResult.exitValue() > 0) {
        logger.error('Could not decompile MCP. Check the output log, fix those problems, and try again')
        throw new GradleScriptException()
    }
}

task copyMcCode(type: Copy, dependsOn: decompileMcp) << {
    from 'mcp/src/minecraft'
    into 'src/main/java'
}

task copyMcAssets(type: Copy, dependsOn: copyMcCode) << {
    from 'mcp/temp/src/minecraft/assets'
    into 'src/main/resources/assets'
}

task copyMcPack(type: Copy, dependsOn: copyMcAssets) << {
    from 'mcp/temp/src/minecraft/pack.png'
    into 'src/main/resources/pack.png'
}

task copyJars(type: Copy, dependsOn: copyMcPack) << {
    from 'mcp/jars'
    into 'jars'
}

task applyPatch(type: Exec, dependsOn: copyJars) << {
    commandLine '../../../../mcp/runtime/bin/applydiff.exe' '-p1' '-i' '../../../../patches/nova.patch'
    workingDir 'src/main/java/net'
}

task cleanupMcp(dependsOn: applyPatch) << {
    def mcpDir = file('mcp')
    mcpDir.delete()
}

task initSubmodules(type: Exec, dependsOn: cleanupMcp) << {
    commandLine 'git' 'submodule' 'update' '--init' '--recursive'
}

task setup(dependsOn: initSubmodules) << {
    logger.info('Nova setup succesfully')
}

static void checkCMake() {
    try {
        def cmakeTest = "cmake --version".execute()
        if(cmakeTest.waitFor() != 0) {
            println 'CMake not found. Please install CMake and add its location to your PATH'
            throw new GradleScriptException()
        } else {
            println 'CMake found!'
        }
    } catch(Exception e) {
        println 'CMake not found. Please install CMake and add its location to your PATH'
        throw new GradleScriptException(e)
    }
}

static boolean hasGCC() {
    try {
        def gccTest = "gcc --version".execute()
        return gccTest.waitFor() == 0
    } catch(Exception e) {
        return false
    }
}

static boolean hasMSVC() {
    try {
        def msvcTest = "msbuild.exe --version".execute()
        return msvcTest.waitFor() == 0
    } catch(Exception e) {
        return false
    }
}

static void checkJava() {
    try {
        def javaTest = "javac -version".execute()
        if(javaTest.waitFor() != 0) {
            println 'JDK not found. Please install the Java 8 JDK and add its location to your PATH'
            throw new GradleScriptException()
        } else {
            println 'JDK found!'
        }
    } catch(Exception e) {
        println 'JDK not found. Please install the Java 8 JDK and add its location to your PATH'
        throw new GradleScriptException(e)
    }
}
